<!DOCTYPE html>
<html>
<head>
    <title>Vagrant Controller</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
            text-align: left;
        }
        .log-container {
            width: 100%;
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Vagrant Controller</h1>
    <p>Public IP: <span id="public-ip">Loading...</span></p>
    <p>Private IP: <span id="private-ip">Loading...</span></p>
    <button onclick="refreshStatus()">Refresh</button>
    <div class="log-container" id="log-container"></div>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>State</th>
                <th>Port</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="vm-table-body">
            <!-- VMs will be dynamically inserted here -->
        </tbody>
    </table>

    <script>
        const logContainer = document.getElementById('log-container');
        const ws = new WebSocket(`ws://${window.location.host}/logs`);
        
        ws.onmessage = (event) => {
            const logEntry = document.createElement('div');
            logEntry.textContent = event.data;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        };
        
        ws.onerror = (event) => {
            const logEntry = document.createElement('div');
            logEntry.style.color = 'red';
            logEntry.textContent = `Error: ${event.data}`;
            logContainer.appendChild(logEntry);
        };
        
        function refreshStatus() {
            fetch('/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ command: 'status', arg: '' }),
            })
            .then(response => response.json())
            .then(data => updateVMTable(data.status))
            .catch(error => console.error('Error:', error));
        }

        function updateVMTable(vmStatuses) {
            const vmTableBody = document.getElementById('vm-table-body');
            vmTableBody.innerHTML = '';

            vmStatuses.forEach(vm => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vm.Name}</td>
                    <td>${vm.State}</td>
                    <td>${vm.Port}</td>
                    <td>
                        ${vm.State === 'running' ? '<button onclick="sendCommand(\'stop\', \'' + vm.Name + '\')">Stop</button>' : ''}
                        ${vm.State === 'not_created' ? '<button onclick="sendCommand(\'start\', \'' + vm.Name + '\')">Start</button>' : ''}
                        ${vm.State !== 'running' && vm.State !== 'not_created' ? '<button onclick="sendCommand(\'start\', \'' + vm.Name + '\')">Start</button>' : ''}
                        ${vm.State === 'running' ? '<button onclick="sendCommand(\'reload\', \'' + vm.Name + '\')">Reload</button>' : ''}
                        ${vm.State === 'running' ? '<button onclick="sendCommand(\'reboot\', \'' + vm.Name + '\')">Reboot</button>' : ''}
                        ${vm.State !== 'running' && vm.State !== 'not_created' && vm.State !== 'poweroff' ? '<button onclick="sendCommand(\'reload\', \'' + vm.Name + '\')">Reload</button>' : ''}
                        ${vm.State !== 'running' && vm.State !== 'not_created' && vm.State !== 'poweroff' ? '<button onclick="sendCommand(\'reboot\', \'' + vm.Name + '\')">Reboot</button>' : ''}
                        ${vm.State !== 'not_created' ? '<button onclick="sendCommand(\'remove\', \'' + vm.Name + '\')">Remove</button>' : ''}
                    </td>
                `;
                vmTableBody.appendChild(row);
            });
        }

        function sendCommand(command, arg) {
            fetch('/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ command, arg }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Command execution failed');
                }
                return response.json();
            })
            .then(data => {
                const logEntry = document.createElement('div');
                logEntry.textContent = `Command: ${command} ${arg} executed successfully`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                refreshStatus();
            })
            .catch(error => {
                const logEntry = document.createElement('div');
                logEntry.style.color = 'red';
                logEntry.textContent = `Error: ${error.message}`;
                logContainer.appendChild(logEntry);
            });
        }

        function fetchIPInfo() {
            fetch('/ipinfo')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('public-ip').textContent = data.publicIP;
                    document.getElementById('private-ip').textContent = data.privateIP;
                })
                .catch(error => console.error('Error fetching IP info:', error));
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            fetchIPInfo();
            refreshStatus();
        });
    </script>
</body>
</html>

